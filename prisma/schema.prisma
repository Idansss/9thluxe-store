// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductCategory {
  PERFUMES
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
}

model User {
  id              String     @id @default(cuid())
  name            String?
  email           String     @unique
  passwordHash    String
  role            Role       @default(USER)
  marketingEmails Boolean    @default(true)
  smsNotifications Boolean   @default(false)
  orderUpdates    Boolean    @default(true)
  wishlistAlerts  Boolean    @default(false)
  resetToken      String?
  resetTokenExpiry DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  accounts     Account[]
  sessions     Session[]
  orders       Order[]
  wishlists    Wishlist[]
  reviews      Review[]
  addresses    Address[]
}

model Category {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  description String?
  enumKey     ProductCategory?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Product {
  id           String      @id @default(cuid())
  name         String
  slug         String      @unique
  description  String
  images       Json        // store image array as JSON
  priceNGN     Int
  oldPriceNGN  Int?
  currency     String      @default("NGN")
  category     ProductCategory
  brand        String?
  productType  String?     // perfume
  notesTop     String?
  notesHeart   String?
  notesBase    String?
  longevity    String?
  occasion     String?
  material     String?
  lensType     String?
  warranty     String?
  waterResistance String?
  stock        Int         @default(10)
  isFeatured   Boolean     @default(false)
  isBestseller Boolean     @default(false)
  isNew        Boolean     @default(false)
  isLimited    Boolean     @default(false)
  deletedAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Social proof cache
  ratingAvg    Float       @default(0)
  ratingCount  Int         @default(0)

  // relations
  collectionId String?
  collection   Collection? @relation(fields: [collectionId], references: [id])
  orderItems   OrderItem[]
  wishlists    Wishlist[]
  reviews      Review[]

  @@index([name])
  @@index([category])
  @@index([ratingAvg])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String
  rating    Int                 // 1–5 (enforce in app)
  comment   String?
  approved  Boolean  @default(true)
  displayName String?
  tag        String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId, createdAt])
  @@index([userId])
}

model Coupon {
  id           String   @id @default(cuid())
  code         String   @unique
  type         String   // "PERCENT" or "FIXED"
  value        Int      // percent (1–100) or NGN amount
  startsAt     DateTime
  endsAt       DateTime
  maxUses      Int?
  usedCount    Int      @default(0)
  minSubtotal  Int?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders       Order[]
}

enum NewsletterStatus {
  DRAFT
  SCHEDULED
  SENT
}

model NewsletterCampaign {
  id        String           @id @default(cuid())
  subject   String
  html      String
  text      String?
  status    NewsletterStatus @default(DRAFT)
  createdAt DateTime         @default(now())
  sentAt    DateTime?
}

model NewsletterSubscriber {
  id          String   @id @default(cuid())
  email       String   @unique
  subscribedAt DateTime @default(now())
  unsubscribedAt DateTime?

  @@index([email])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // "ORDER_PAID", "ORDER_SHIPPED", etc.
  title     String
  message   String
  orderId   String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  readAt    DateTime?

  @@index([read, createdAt])
  @@index([orderId])
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String?
  line1      String
  city       String
  state      String
  postalCode String?
  phone      String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, isDefault])
}

model Order {
  id           String       @id @default(cuid())
  userId       String
  user         User         @relation(fields: [userId], references: [id])

  status       OrderStatus  @default(PENDING)

  // Pricing breakdown
  subtotalNGN  Int          @default(0)
  discountNGN  Int          @default(0)
  totalNGN     Int

  // Optional coupon applied
  couponId     String?
  coupon       Coupon?      @relation(fields: [couponId], references: [id])

  reference    String?      @unique
  items        OrderItem[]

  // Shipping/contact snapshot
  addressLine1 String
  city         String
  state        String
  phone        String

  createdAt    DateTime     @default(now())

  @@index([status, createdAt])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  priceNGN  Int

  @@index([orderId])
  @@index([productId])
}

model Collection {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([createdAt])
}

// --- Auth models ---

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Role {
  USER
  ADMIN
}
