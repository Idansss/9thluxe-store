// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Category {
  WATCHES
  PERFUMES
  GLASSES
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
}

model User {
  id              String     @id @default(cuid())
  name            String?
  email           String     @unique
  passwordHash    String
  marketingEmails Boolean    @default(true)
  smsNotifications Boolean   @default(false)
  resetToken      String?
  resetTokenExpiry DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  accounts     Account[]
  sessions     Session[]
  orders       Order[]
  wishlists    Wishlist[]
  reviews      Review[]
  addresses    Address[]
}

model Product {
  id           String      @id @default(cuid())
  name         String
  slug         String      @unique
  description  String
  images       Json        // store image array as JSON for SQLite
  priceNGN     Int
  category     Category
  brand        String?
  stock        Int         @default(10)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Social proof cache
  ratingAvg    Float       @default(0)
  ratingCount  Int         @default(0)

  // relations
  orderItems   OrderItem[]
  wishlists    Wishlist[]
  reviews      Review[]

  @@index([name])
  @@index([category])
  @@index([ratingAvg])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String
  rating    Int                 // 1–5 (enforce in app)
  comment   String?
  approved  Boolean  @default(true)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId, createdAt])
  @@index([userId])
}

model Coupon {
  id           String   @id @default(cuid())
  code         String   @unique
  type         String   // "PERCENT" or "FIXED"
  value        Int      // percent (1–100) or NGN amount
  startsAt     DateTime
  endsAt       DateTime
  maxUses      Int?
  usedCount    Int      @default(0)
  minSubtotal  Int?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders       Order[]
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  line1     String
  city      String
  state     String
  phone     String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, isDefault])
}

model Order {
  id           String       @id @default(cuid())
  userId       String
  user         User         @relation(fields: [userId], references: [id])

  status       OrderStatus  @default(PENDING)

  // Pricing breakdown
  subtotalNGN  Int          @default(0)
  discountNGN  Int          @default(0)
  totalNGN     Int

  // Optional coupon applied
  couponId     String?
  coupon       Coupon?      @relation(fields: [couponId], references: [id])

  reference    String?      @unique
  items        OrderItem[]

  // Shipping/contact snapshot
  addressLine1 String
  city         String
  state        String
  phone        String

  createdAt    DateTime     @default(now())

  @@index([status, createdAt])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  priceNGN  Int

  @@index([orderId])
  @@index([productId])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([createdAt])
}

// --- Auth models ---

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
